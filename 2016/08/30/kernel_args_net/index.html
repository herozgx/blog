<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.1.0" />






<meta name="description" content="很多诡异的问题往往是由于系统的参数设置不当导致, 这里主要记录一下Linux常用的网络调优参数, 方便日后查阅，也希望能够帮助到他人。">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux网络内核参数">
<meta property="og:url" content="https://herozgx.github.io/blog/2016/08/30/kernel_args_net/index.html">
<meta property="og:site_name" content="herozgx">
<meta property="og:description" content="很多诡异的问题往往是由于系统的参数设置不当导致, 这里主要记录一下Linux常用的网络调优参数, 方便日后查阅，也希望能够帮助到他人。">
<meta property="og:updated_time" content="2017-01-04T15:16:48.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux网络内核参数">
<meta name="twitter:description" content="很多诡异的问题往往是由于系统的参数设置不当导致, 这里主要记录一下Linux常用的网络调优参数, 方便日后查阅，也希望能够帮助到他人。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://herozgx.github.io/blog/2016/08/30/kernel_args_net/"/>





  <title> Linux网络内核参数 | herozgx </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">herozgx</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Stay hungry, stay foolish.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tech">
          <a href="/blog/2016/12/03/tech_list" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-laptop"></i> <br />
            
            技术
          </a>
        </li>
      
        
        <li class="menu-item menu-item-book">
          <a href="/blog/2016/12/03/book_list" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            读书
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://herozgx.github.io/blog/blog/2016/08/30/kernel_args_net/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Guanxiong Zhao">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/blog/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="herozgx">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="herozgx" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Linux网络内核参数
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-30T00:06:46+08:00">
                2016-08-30
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>很多诡异的问题往往是由于系统的参数设置不当导致, 这里主要记录一下Linux常用的网络调优参数, 方便日后查阅，也希望能够帮助到他人。<br><a id="more"></a></p>
<h1 id="ip-forward"><a href="#ip-forward" class="headerlink" title="ip_forward"></a>ip_forward</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">proc: /proc/sys/net/ipv4/ip_forward</div><div class="line">sysctl.conf: net.ipv4.ip_forward = 0</div></pre></td></tr></table></figure>
<ul>
<li>0: 关闭(默认)</li>
<li>非0: 启用</li>
</ul>
<p>在接口间传递数据包, 这个变量很特殊， 它的变更会导致所有配置参数变为默认配置<br>? 我们设定操作系统做网络转发， 或iptables做FORWARD链时需要开启该参数。</p>
<h1 id="somaxconn"><a href="#somaxconn" class="headerlink" title="somaxconn"></a>somaxconn</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">proc:  /proc/sys/net/core/somaxconn</div><div class="line">sysctl.conf: net.core.somaxconn = 256</div></pre></td></tr></table></figure>
<p>监听队列长度的上限。 它是操作系统设置的一个全局参数， 规定了每个端口的最大监听队列长度， 默认为128。<br>注意这里的“上限”， 它是操作系统设置的一个阈值， 所有网络应用程序都可以设置自己的监听队列长度(listen()函数的backlog参数)，如nginx中的listen的backlog配置， 只要它不超过somaxconn。 监听队列长度一般取：min(backlog, somaxconn)<br>对于HTTP端口这种处理大量连接请求的端口， 128这个上限有点小， 可以增加到1024以上。</p>
<blockquote>
<p>The  behavior of the backlog argument on TCP sockets changed with Linux 2.2.  Now it specifies the queue length for completely established sockets waiting to be accepted, instead of the number of incomplete connection requests.  The maximum length of  the  queue  for  incomplete  sockets  can  be  set  using /proc/sys/net/ipv4/tcp_max_syn_backlog.   When syncookies are enabled there is no logical maximum length and this setting is ignored.  See tcp(7) for more information.<br>If the backlog argument is greater than the value in /proc/sys/net/core/somaxconn, then it is silently truncated to that value; the default value in  this file is 128.  In kernels before 2.4.25, this limit was a hard coded value, SOMAXCONN, with the value 128.</p>
<p>注： Linux2.2内核以后backlog参数含义改为： 已完成3次握手建立了连接， 正在等待被程序accept的队列长度,  属于“连接队列”， 不再是未完成连接的队列长度,  半连接队列的长度改由另一个系统参数设定: tcp_max_syn_backlog  </p>
</blockquote>
<p>参考：<a href="http://veithen.github.io/2014/01/01/how-tcp-backlog-works-in-linux.html" target="_blank" rel="external">backlog in linux</a></p>
<h1 id="tcp-max-syn-backlog"><a href="#tcp-max-syn-backlog" class="headerlink" title="tcp_max_syn_backlog"></a>tcp_max_syn_backlog</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">proc:  /proc/sys/net/ipv4/tcp_max_syn_backlog</div><div class="line">sysctl.conf:  net.ipv4.tcp_max_syn_backlog = 128</div></pre></td></tr></table></figure>
<p>半连接队列的最大长度。</p>
<blockquote>
<p>The maximum number of queued connection requests which have still not received an acknowledgement from the connecting client.<br>If this number is exceeded, the kernel will begin dropping requests. The default value of 256 is increased to 1024 when the<br>memory present in the system is adequate or greater (&gt;= 128Mb), and reduced to 128 for those systems with very low memory (&lt;=<br>32Mb). It is recommended that if this needs to be increased above 1024, TCP_SYNQ_HSIZE in include/net/tcp.h be modified to<br>keep TCP_SYNQ_HSIZE*16&lt;=tcp_max_syn_backlog, and the kernel be recompiled.</p>
</blockquote>
<p>处于LISTEN状态的端口接收到Client的SYN包并发回SYN/ACK包后，状态变为SYN_REVD,  此时尚未收到Client的确认ACK包， 为”半连接状态”， <em>tcp_max_syn_backlog</em>规定了这种半连接的最大个数, 如果超过这个值， 内核将丢弃新来的SYN包。这个参数的最小值为128。<br>提供Web服务的服务器一般需要调大这个参数的值， 因为web服务器会处理高并发的请求。</p>
<h1 id="tcp-syncookies"><a href="#tcp-syncookies" class="headerlink" title="tcp_syncookies"></a>tcp_syncookies</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">proc: /proc/sys/net/ipv4/tcp_syncookies</div><div class="line">sysctl.conf: net.ipv4.tcp_syncookies = 1</div></pre></td></tr></table></figure>
<blockquote>
<p>Note, that syncookies is fallback facility. It MUST NOT be used to help highly loaded servers to stand against legal connection rate. If you see synflood warnings in your logs, but investigation shows that they occur because of overload with legal connections, you should tune another parameters until this warning disappear.</p>
</blockquote>
<p>如Linux官方文档所述， tcp_syncookies属于后备设施， 它不能帮助解决大量的合法连接造成的服务器负载问题。</p>
<h1 id="net-ipv4-tcp-timestamps-1"><a href="#net-ipv4-tcp-timestamps-1" class="headerlink" title="net.ipv4.tcp_timestamps = 1"></a>net.ipv4.tcp_timestamps = 1</h1><h1 id="net-ipv4-tcp-tw-recycle-0"><a href="#net-ipv4-tcp-tw-recycle-0" class="headerlink" title="net.ipv4.tcp_tw_recycle = 0"></a>net.ipv4.tcp_tw_recycle = 0</h1><h1 id="net-ipv4-tcp-tw-reuse-0"><a href="#net-ipv4-tcp-tw-reuse-0" class="headerlink" title="net.ipv4.tcp_tw_reuse = 0"></a>net.ipv4.tcp_tw_reuse = 0</h1><h1 id="TIME-WAIT-过多"><a href="#TIME-WAIT-过多" class="headerlink" title="TIME-WAIT 过多"></a>TIME-WAIT 过多</h1><h1 id="CLOSE-WAIT-过多"><a href="#CLOSE-WAIT-过多" class="headerlink" title="CLOSE-WAIT 过多"></a>CLOSE-WAIT 过多</h1>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2016/08/29/yum/" rel="next" title="Yum详解">
                <i class="fa fa-chevron-left"></i> Yum详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2016/08/30/bonding/" rel="prev" title="bonding技术及配置">
                bonding技术及配置 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/blog/images/avatar.gif"
               alt="Guanxiong Zhao" />
          <p class="site-author-name" itemprop="name">Guanxiong Zhao</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/blog/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ip-forward"><span class="nav-number">1.</span> <span class="nav-text">ip_forward</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#somaxconn"><span class="nav-number">2.</span> <span class="nav-text">somaxconn</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#tcp-max-syn-backlog"><span class="nav-number">3.</span> <span class="nav-text">tcp_max_syn_backlog</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#tcp-syncookies"><span class="nav-number">4.</span> <span class="nav-text">tcp_syncookies</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#net-ipv4-tcp-timestamps-1"><span class="nav-number">5.</span> <span class="nav-text">net.ipv4.tcp_timestamps = 1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#net-ipv4-tcp-tw-recycle-0"><span class="nav-number">6.</span> <span class="nav-text">net.ipv4.tcp_tw_recycle = 0</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#net-ipv4-tcp-tw-reuse-0"><span class="nav-number">7.</span> <span class="nav-text">net.ipv4.tcp_tw_reuse = 0</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TIME-WAIT-过多"><span class="nav-number">8.</span> <span class="nav-text">TIME-WAIT 过多</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CLOSE-WAIT-过多"><span class="nav-number">9.</span> <span class="nav-text">CLOSE-WAIT 过多</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guanxiong Zhao</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
